<div id="actions">
  <input type="button" id="assign_cycle" value="Cycle"/>
  <input type="button" id="remove_cycle" value="Remove"/>
</div>


<div id="assign_dialog" title="Assign script to cycle">
  <form id="assignForm">

    <div id="approachTree" class="tree"></div>

  </form>
</div>


<script type="text/javascript">
  $(document).ready(function() {

    var assignButton = $("#assign_cycle").button({
      icons: { primary: "ui-icon-person" }, text: true
    });
    assignButton.click(function() {
      $("#assign_dialog").dialog("open");
    });

    var removeButton = $("#remove_cycle").button();
    removeButton.click(function () {
      var $tree = jQuery.jstree._reference('#scriptCycleTree');
      var selectedNode = $tree.get_selected();
      if (isSelectedNodeOfType($tree, selectedNode, ['default', 'instance'])) {
        selectedNode.data("args", {scriptId: "${script.id}"});
        $tree.delete_node(selectedNode);
        refreshCycleTree();
      }
    });

    $("#assign_dialog").dialog({
      autoOpen: false,
      height: 550,
      width: 300,
      modal: true,
      buttons: {
        "Assign to cycle": function() {

          var valid = false;
          var treeContainer = $("#approachTree");
          var $tree = jQuery.jstree._reference(treeContainer);
          var selectedNode = $tree.get_selected();
          if ($tree._get_type(selectedNode) == 'testCycle') {
            valid = true;
          } else {
            // display validation error or message somehow
            alert("You need to select a cycle");
          }

          if (valid) {
            var name = selectedNode.text();
            $("#scriptCycleTree").jstree("create", null, "last", {attr: {"rel": "testCycle"}, data: name, metadata: {args: {cycleNodeId: selectedNode.attr('id').replace('node_', ''), scriptId: "${script.id}"}}}, null, true);
            refreshCycleTree();
            $(this).dialog("close");
          }
        },
        Cancel: function() {
          $(this).dialog("close");
        }
      }
    });

    #{include 'Approach/approachTree.js' /}
    #{tree.common id:"approachTree", controller:"TMTreeController" /}

    function refreshCycleTree() {
      var cycleTreeContainer = $("#scriptCycleTree");
      jQuery.jstree._reference(cycleTreeContainer).refresh();
      jQuery.jstree._reference(cycleTreeContainer).deselect_all();
    }

  });
</script>

