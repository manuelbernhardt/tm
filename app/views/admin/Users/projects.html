


<div id="deleteRoleConfirmationDialog" title="Role removal confirmation"></div>

<div id="treeDiv">
  <button id="assign-role">Role</button>
  <button id="unassign-role">Remove</button>
  <div id="projectRolesTree" class="tree"></div>
</div>

<div id="assign-dialog" title="Assign a new role" class="modalDialog">
  <form id="assignForm">
    <fieldset>

      <label for="categories">Project category</label>
      #{select 'categories', items:projectCategories, valueProperty:'id', labelProperty:'name', class:"text ui-widget-content ui-corner-all", id:'categories'}
      #{option -1} No category #{/option}
      #{/select}

      <label for="projects">Project</label>
      #{select 'projects', valueProperty:'id', labelProperty:'name', class:"text ui-widget-content ui-corner-all", id:'projects'}
      #{option -1} Please select a project #{/option}
      #{/select}

      <label for="roles">Role</label>
      #{select 'roles', valueProperty:'id', labelProperty:'name', class:"text ui-widget-content ui-corner-all", id:'roles'}
      #{option -1} Please select a role #{/option}
      #{/select}

    </fieldset>
  </form>
</div>

<script type="text/javascript">


  $(document).ready(function () {

    $("#assign-dialog").dialog({
              autoOpen: false,
              height: 300,
              width: 350,
              modal: true,
              buttons: {
                "Assign role": function() {
                  registerSelectNoneValidator();

                  var selectedProjectId = $('#projects option:selected').val();
                  var selectedRoleId = $('#roles option:selected').val();

                  var v = $("#assignForm").validate({
                            rules: {
                              projects: {selectNone: true},
                              roles: {selectNone: true}
                            },
                            messages: {
                              projects: "Please select a project",
                              roles: "Please select a role"
                            }
                          });

                  // programmatic validation
                  var valid = v.form();

                  if (valid) {
                    var name = $('#roles option:selected').text();
                    $("#projectRolesTree").jstree("create", -1, "last", {attr: {"rel": "default"}, data: name, metadata: {args: {roleId: selectedRoleId, userId: getSelectedRowId('#tab')}}}, null, true);
                    var treeContainer = $("#projectRolesTree");
                    jQuery.jstree._reference(treeContainer).refresh();
                    jQuery.jstree._reference(treeContainer).deselect_all();
                    $(this).dialog("close");
                  } else {
                    errorHandler("Not valid");
                  }
                },
                Cancel: function() {
                  $("#assignForm").validate().resetForm();
                  $(this).dialog("close");
                }
              }
            });

    $("#assign-role").button({icons: {primary: 'ui-icon-plus'}}).click(function() {
      $("#assign-dialog").dialog("open");
    });

    $("#unassign-role").button({icons: {primary: 'ui-icon-trash'}, text:false, disabled: true}).click(function() {

      deletionConfirmation('deleteRoleConfirmationDialog', 'Project role for', getSelectedRowColumn($('#tab').dataTable(), 1) + " " + getSelectedRowColumn($('#tab').dataTable(), 2),  function(){
          var $tree = jQuery.jstree._reference('#projectRolesTree');
          var selectedNode = $tree.get_selected();
          if ($tree._get_type(selectedNode) == "default") {
            selectedNode.data("args", {userId: getSelectedRowId('#tab')});
            $tree.delete_node(selectedNode);
          }
      });

    });

    $("#projectRolesTree").tree({"args" : {"userId": 1}, types: projectRoleTreeTypes});

    $("#projectRolesTree").bind("select_node.jstree", function (e, data) {
      // pre-select assignment form fields based on what we select in the tree

      // category selected
      if (data.inst._get_type(data.rslt.obj) == "category") {
        $("#unassign-role").button('disable');

        var categoryId = extractId(data.rslt.obj.attr("id"));
        selectCategory(categoryId);
        $('#categories').val(categoryId);
        // project selected
      } else if (data.inst._get_type(data.rslt.obj) == "project") {
        $("#unassign-role").button('disable');

        var parent = data.inst._get_parent(data.rslt.obj);
        selectCategory(extractId($(parent).attr("id")));
        setCategory(parent);
        var projectId = extractId(data.rslt.obj.attr("id"));
        selectProject(projectId, function() {
          $('#projects').val(projectId);
        });
        // role selected
      } else {

        $("#unassign-role").button('enable');

        var roleId = extractId(data.rslt.obj.attr("id"));
        var roleParent = data.inst._get_parent(data.rslt.obj);
        var pId = extractId($(roleParent).attr("id"));
        var projectParent = data.inst._get_parent(roleParent);
        var cId = -1;
        if (typeof projectParent !== 'undefined') {
          cId = extractId($(projectParent).attr("id"));
        }
        selectCategory(cId, function() {
          setCategory($(projectParent));
          selectProject(pId, function() {
            $('#projects').val(pId);
            $('#roles').val(roleId);
          });
        });
      }
    });

    // run ajax callbacks to update the selects
    $('#categories').change(function() {
      var categoryId = $('#categories option:selected').val();
      selectCategory(categoryId, function() {
        setCategory(categoryId);
      });
    });

    $('#projects').change(function() {
      var project = $('#projects option:selected').val();
      selectProject(project, null);
    });
  });

  function selectCategory(categoryId, callback) {
    $('#projects').attr('disabled', false);
    $('#projects').find('option').remove().end();
    $('#projects').addOption('-1', 'Please select a project');
    $('#roles').find('option').remove().end();
    $('#roles').addOption('-1', 'Please select a role');
    $('#roles').attr('disabled', true);
    $('#projects').ajaxAddOption('@{admin.Users.projectOptions()}', {categoryId: categoryId, accountId: '1'}, false, callback);
  }

  function selectProject(projectId, callback) {
    $('#roles').attr('disabled', false);
    $('#roles').find('option').remove().end();
    $('#roles').addOption('-1', 'Please select a role');
    $('#roles').ajaxAddOption('@{admin.Users.rolesOptions()}', {projectId: projectId}, false, callback);
  }

  function setCategory(parent) {
    if (typeof parent !== 'undefined') {
      var categoryId = extractId(parent.attr("id"));
      $('#categories').val(categoryId);
    } else {
      $('#categories').val(-1); // no category
    }
  }
</script>

