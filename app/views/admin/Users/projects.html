


<div id="deleteRoleConfirmationDialog" title="Role removal confirmation"></div>

<div id="treeDiv">
  <button id="assign-role">Role</button>
  <button id="unassign-role">Remove</button>
<span data-bind="text: fullName"></span>

</div>

<div id="assign-dialog" title="Assign a new role" class="modalDialog">
    <div id="categoriesContainer">
        <select id="categoriesSelect" data-bind="options:categories,
                       optionsValue:'categoryValue',
                       optionsText:'categoryName',
                       optionsCaption:'Select category...'">

        </select>
    </div>
    <div id="projectsContainer">
        <select id="projectsSelect" data-bind="options:projects,
                       optionsValue:'projectValue',
                       optionsText:'projectName',
                       optionsCaption:'Select project...'">

        </select>
    </div>
    <div id="rolesContainer">
        <select id="rolesSelect" data-bind="options:roles,
                       optionsValue:'roleValue',
                       optionsText:'roleName',
                       optionsCaption:'Select role...'">

        </select>
    </div>
</div>

<script type="text/javascript">


  $(document).ready(function () {

      var viewModelCategory = {};
      var viewModelProject = {};
      var viewModelRole = {};

      handleRowSelection("#tab",function(){
          $.getJSON('@{admin.Users.categoryOptions()}', function(data){

                if(!ko.mapping.isMapped(viewModelCategory)){
                    viewModelCategory = ko.mapping.fromJS(data);
                    ko.applyBindings(viewModelCategory, document.getElementById('categoriesContainer'));
                }
                else{
                    ko.mapping.updateFromJS(viewModelCategory,data);
                }
          });

      });

      $('#categoriesSelect').change(function(){
          var categoryId = $(this).val();
          if(categoryId==''){
              categoryId='-1';
          }
          $.getJSON('@{admin.Users.projectOptions()}', {categoryId: categoryId}, function(data){
                if(!ko.mapping.isMapped(viewModelProject)){
                    viewModelProject = ko.mapping.fromJS(data);
                    ko.applyBindings(viewModelProject, document.getElementById('projectsContainer'));
                }
                else{
                    ko.mapping.updateFromJS(viewModelProject,data);
                }
          });
      });

      $('#projectsSelect').change(function(){
          var projectId = $(this).val();
          if(projectId==''){
              projectId='-1';
          }
          alert(projectId);
          $.getJSON('@{admin.Users.rolesOptions()}', {projectId: projectId}, function(data){
                if(!ko.mapping.isMapped(viewModelRole)){
                    viewModelRole = ko.mapping.fromJS(data);
                    ko.applyBindings(viewModelRole, document.getElementById('rolesContainer'));
                }
                else{
                    ko.mapping.updateFromJS(viewModelRole,data);
                }
          });
      });


    $("#assign-dialog").dialog({
              autoOpen: false,
              height: 300,
              width: 350,
              modal: true,
              buttons: {
                "Assign role": function() {

                },
                "Cancel": function() {

                  $(this).dialog("close");
                }
              }
            });

    $("#assign-role").button({icons: {primary: 'ui-icon-plus'}}).click(function() {
      $("#assign-dialog").dialog("open");
    });

    $("#unassign-role").button({icons: {primary: 'ui-icon-trash'}, text:false, disabled: true}).click(function() {

      deletionConfirmation('deleteRoleConfirmationDialog', 'Project role for', getSelectedRowColumn($('#tab').dataTable(), 1) + " " + getSelectedRowColumn($('#tab').dataTable(), 2),  function(){
//          var $tree = jQuery.jstree._reference('#projectRolesTree');
//          var selectedNode = $tree.get_selected();
//          if ($tree._get_type(selectedNode) == "default") {
//            selectedNode.data("args", {userId: getSelectedRowId('#tab')});
//            $tree.delete_node(selectedNode);
//          }
      });

    });



  });
</script>

