<script type="text/javascript">
  $(document).ready(function () {
    var tree = $("#projectTree").jstree({
      "plugins" : [ "json_data", "ui", "crrm",  "types", "contextmenu", "hotkeys", "themes" ],

      "json_data" : {
        "ajax" : {
          "url" : "@{TMTreeController.getChildren()}",
          "data" : function (n) {
            return {
              "id" : n.attr ? n.attr("id").replace("node_", "") : -1,
              "treeId" : "projectTree"
            };
          }
        }
      },
      "types" : {
        "max_depth" : -2,
        "max_children" : -2,
        "types" : {
          "default" : {
            "valid_children" : "none",
            "icon" : {
              "image" : "@{'public/images/jstree/file.png'}" // TODO icon for project
            }
          },
          "category" : {
            "valid_children" : [ "default" ],
            "icon" : {
              "image" : "@{'public/images/jstree/folder.png'}"
            },
            "start_drag" : false,
            "move_node" : false,
            "delete_node" : true,
            "remove" : true
          },
          "root" : {
            "valid_children" : [ "default", "category" ],
            "icon" : {
              "image" : "@{'public/images/jstree/folder.png'}"
            },
            "start_drag" : false,
            "move_node" : false,
            "delete_node" : false,
            "remove" : false
          }
        }
      },
      "hotkeys": {
        "Ctrl+x" : function() {
          this.cut(null)
        },
        "Ctrl+v" : function() {
          this.paste(null)
        },
        "Ctrl+n" : function() {
          this.create_node(null, "after", {attr:{"rel":"category"}});
        }
      }
    });
    #{tree.common id:"projectTree", controller:"TMTreeController" /}

    /** Selection listener **/
    $("#projectTree").bind("select_node.jstree", function (e, data) {
      var tabLinks = ['@{admin.Projects.projectDetails()}', '@{admin.Projects.roles()}', '@{admin.Projects.users()}'];
      treeNodeSelectionHandler(tabLinks, 'default', 'project', $('#innerTabs'), data);
    });

    /** Button initialisation **/
    $("#create_category").click(function () {
      $("#projectTree").jstree("create", null, "last", {attr:{"rel":"category"}});
    });

    $("#create_project").click(function () {
      $("#projectTree").jstree("create", null, "last", {attr:{"rel":"default"}});
    });

    $("#remove").click(function () {
      $("#projectTree").jstree("remove", null);
    });

  });
</script>

<div id="projectTree" class="tree"></div>

<input type="button" id="create_category" value="New project category"/>
<input type="button" id="create_project" value="New project"/>
<input type="button" id="remove" value="Remove"/>