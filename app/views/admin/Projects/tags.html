#{if projectId == null}
No project selected
#{/if}
#{else}
<!-- add tags dialog -->
<div id="requirementAddTagDialog" title="Add new tag">
    <input id="requirementAddTagInput"/>
</div>
<div id="testScriptAddTagDialog" title="Add new tag">
    <input id="testScriptAddTagInput"/>
</div>
<div id="testInstanceAddTagDialog" title="Add new tag">
    <input id="testInstanceAddTagInput"/>
</div>
<div id="defectAddTagDialog" title="Add new tag">
    <input id="defectAddTagInput"/>
</div>
<!-- end of add tags dialogs -->

<!-- rename dialogs -->
<div id="requirementRenameDialog" title="Rename the tag">
    <input id="requirementRenameInput"/>
</div>

<div id="testScriptRenameDialog" title="Rename the tag">
    <input id="testScriptRenameInput"/>
</div>

<div id="testInstanceRenameDialog" title="Rename the tag">
    <input id="testInstanceRenameInput"/>
</div>

<div id="defectRenameDialog" title="Rename the tag">
    <input id="defectRenameInput"/>
</div>
<!-- end of rename dialogs -->

<!-- merge dialogs -->
<div id="mergeTagDialogRequirement" title="Merge tags">
    Tag with this name already exists, do you want to merge those?
</div>

<div id="mergeTagDialogTestInstance" title="Merge tags">
    Tag with this name already exists, do you want to merge those?
</div>

<div id="mergeTagDialogTestScript" title="Merge tags">
    Tag with this name already exists, do you want to merge those?
</div>

<div id="mergeTagDialogDefect" title="Merge tags">
    Tag with this name already exists, do you want to merge those?
</div>
<!-- end of merge dialogs -->



<div class="accordion ui-accordion ui-widget ui-helper-reset ui-accordion-icons" role="tablist">

        <h3 class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top ui-state-focus" role="tab" aria-expanded="true" aria-selected="true" tabindex="0"><span class="ui-icon ui-icon-triangle-1-s"></span><a href="#">Requirement</a></h3>
        <div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"  role="tabpanel">

            <button id="requirementAddTag">Tag</button>
            <button id="requirementRenameTag">Rename</button>
            <button id="requirementDeleteTag">Delete</button>
            <table id="requirement" class="display">
              <thead>
              <tr>
                <th>Tag</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
        <h3 class="ui-accordion-header ui-helper-reset ui-state-default ui-corner-all" role="tab" aria-expanded="false" aria-selected="false" tabindex="-1"><span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">Test script</a></h3>
        <div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" style=" display: none; " role="tabpanel">

            <button id="testScriptAddTag">Tag</button>
            <button id="testScriptRenameTag">Rename</button>
            <button id="testScriptDeleteTag">Delete</button>
            <table id="testScript" class="display">
              <thead>
              <tr>
                <th>Tag</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
        <h3 class="ui-accordion-header ui-helper-reset ui-state-default ui-corner-all" role="tab" aria-expanded="false" aria-selected="false" tabindex="-1"><span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">Test instance</a></h3>
        <div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" style="display: none; " role="tabpanel">

            <button id="testInstanceAddTag">Tag</button>
            <button id="testInstanceRenameTag">Rename</button>
            <button id="testInstanceDeleteTag">Delete</button>
            <table id="testInstance" class="display">
              <thead>
              <tr>
                <th>Tag</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
        <h3 class="ui-accordion-header ui-helper-reset ui-state-default ui-corner-all" role="tab" aria-expanded="false" aria-selected="false" tabindex="-1"><span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">Defect</a></h3>
        <div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" style="display: none; " role="tabpanel">

            <button id="defectAddTag">Tag</button>
            <button id="defectRenameTag">Rename</button>
            <button id="defectDeleteTag">Delete</button>
            <table id="defect" class="display">
              <thead>
              <tr>
                <th>Tag</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>

</div>

        <script type="text/javascript">

            // hack for fetching second tag ID
            var secondTagIdRequirement = null;
            var secondTagIdTestScript = null;
            var secondTagIdTestInstance = null;
            var secondTagIdDefect = null;

            $(".accordion").accordion({
                header: "h3",
                autoHeight: false,
                change: function(){
                    $('.display').attr("style", "width:100%"); // hack because of css/js conflicts between accordion and data tables
                }
            });

            // button for requirement tag renaming
            $('#requirementRenameTag').button({icons: {primary: 'ui-icon-pencil'}, disabled:true});
            $("#requirementRenameTag").click(function(){
                $('#requirementRenameDialog').dialog("open");
                var dataTableRequirement = $('#requirement').dataTable();
                $('#requirementRenameInput').val(getSelectedRowColumn(dataTableRequirement,1));
            });

            //dialog for requirement tag renaming
            $('#requirementRenameDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.renameTag()}', {tagId: getSelectedRowId('#requirement'), tagNewName: $('#requirementRenameInput').val(), projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    if(data!=null && data!=''){
                                        secondTagIdRequirement = data;
                                        $('#mergeTagDialogRequirement').dialog("open");
                                    }
                                    refreshTableContents('#requirement', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);
                    
                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            // row selection handler for requirement tag table
            handleRowSelection("#requirement", function(data){
                if(getSelectedRowId("#requirement")!=null && getSelectedRowId("#requirement")!='')
                    $("#requirementRenameTag").button("enable");
                    $("#requirementDeleteTag").button("enable");
            });

            // button for test script tag renaming
            $('#testScriptRenameTag').button({icons: {primary: 'ui-icon-pencil'}, disabled:true});
            $("#testScriptRenameTag").click(function(){
                $('#testScriptRenameDialog').dialog("open");
                var dataTableTestScript = $('#testScript').dataTable();
                $('#testScriptRenameInput').val(getSelectedRowColumn(dataTableTestScript,1));
            });

            //dialog for test script tag renaming
            $('#testScriptRenameDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.renameTag()}', {tagId: getSelectedRowId('#testScript'), tagNewName: $('#testScriptRenameInput').val(), projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    if(data!=null && data!=''){
                                        secondTagIdTestScript = data;
                                        $('#mergeTagDialogTestScript').dialog("open");
                                    }
                                    refreshTableContents('#testScript', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            handleRowSelection("#testScript", function(){
                if(getSelectedRowId("#testScript")!=null && getSelectedRowId("#testScript")!='')
                    $("#testScriptRenameTag").button("enable");
                    $("#testScriptDeleteTag").button("enable");
            });

            // button for test instance tag renaming
            $('#testInstanceRenameTag').button({icons: {primary: 'ui-icon-pencil'}, disabled:true});
            $("#testInstanceRenameTag").click(function(){
                $('#testInstanceRenameDialog').dialog("open");
                var dataTableTestInstance = $('#testInstance').dataTable();
                $('#testInstanceRenameInput').val(getSelectedRowColumn(dataTableTestInstance,1));
            });

            //dialog for test instance tag renaming
            $('#testInstanceRenameDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.renameTag()}', {tagId: getSelectedRowId('#testInstance'), tagNewName: $('#testInstanceRenameInput').val(), projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    if(data!=null && data!=''){
                                        secondTagIdTestInstance = data;
                                        $('#mergeTagDialogTestInstance').dialog("open");
                                    }
                                    refreshTableContents('#testInstance', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            handleRowSelection("#testInstance", function(){
                if(getSelectedRowId("#testInstance")!=null && getSelectedRowId("#testInstance")!='')
                     $("#testInstanceRenameTag").button("enable");
                     $("#testInstanceDeleteTag").button("enable");
            });

            // button for defect tag renaming
            $('#defectRenameTag').button({icons: {primary: 'ui-icon-pencil'}, disabled:true});
            $("#defectRenameTag").click(function(){
                $('#defectRenameDialog').dialog("open");
                var dataTableDefect = $('#defect').dataTable();
                $('#defectRenameInput').val(getSelectedRowColumn(dataTableDefect,1));
            });

            //dialog for defect tag renaming
            $('#defectRenameDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.renameTag()}', {tagId: getSelectedRowId('#defect'), tagNewName: $('#defectRenameInput').val(), projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    if(data!=null && data!=''){
                                        secondTagIdDefect = data;
                                        $('#mergeTagDialogDefect').dialog("open");
                                    }
                                    refreshTableContents('#defect', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            handleRowSelection("#defect", function(){
                if(getSelectedRowId("#defect")!=null && getSelectedRowId("#defect")!='')
                    $("#defectRenameTag").button("enable");
                    $("#defectDeleteTag").button("enable");

            });

            <!-- section of JS for tag merging -->

            $('#mergeTagDialogRequirement').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.mergeTags()}', {firstTagId: getSelectedRowId('#requirement'), secondTagId: secondTagIdRequirement, projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    refreshTableContents('#requirement', false);
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            $('#mergeTagDialogTestScript').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.mergeTags()}', {firstTagId: getSelectedRowId('#testScript'), secondTagId: secondTagIdTestScript, projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    refreshTableContents('#testScript', false);
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            $('#mergeTagDialogTestInstance').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.mergeTags()}', {firstTagId: getSelectedRowId('#testInstance'), secondTagId: secondTagIdTestInstance , projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    refreshTableContents('#testInstance', false);
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            $('#mergeTagDialogDefect').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.mergeTags()}', {firstTagId: getSelectedRowId('#defect'), secondTagId: secondTagIdDefect, projectId:'${projectId}'})
                            .success(
                                function(data) {
                                    refreshTableContents('#defect', false);
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });

            <!-- end of section of JS for merging tags -->

            <!-- section of JS for adding new tags for requirements -->
            $('#requirementAddTag').button({icons: {primary: 'ui-icon-plus'}});
            $("#requirementAddTag").click(function(){
                $('#requirementAddTagDialog').dialog("open");
            });

            $('#requirementAddTagDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.addTag()}', {projectId:'${projectId}', name: $('#requirementAddTagInput').val(),type: "requirement" })
                            .success(
                                function(data) {
                                    refreshTableContents('#requirement', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });
            <!-- end of section of JS for adding new tags -->

            <!-- section of JS for adding new tags for test script -->
            $('#testScriptAddTag').button({icons: {primary: 'ui-icon-plus'}});
            $("#testScriptAddTag").click(function(){
                $('#testScriptAddTagDialog').dialog("open");
            });

            $('#testScriptAddTagDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.addTag()}', {projectId:'${projectId}', name: $('#testScriptAddTagInput').val(),type: "testScript" })
                            .success(
                                function(data) {
                                    refreshTableContents('#testScript', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });
            <!-- end of section of JS for adding new tags -->

            <!-- section of JS for adding new tags for test instance-->
            $('#testInstanceAddTag').button({icons: {primary: 'ui-icon-plus'}});
            $("#testInstanceAddTag").click(function(){
                $('#testInstanceAddTagDialog').dialog("open");
            });

            $('#testInstanceAddTagDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.addTag()}', {projectId:'${projectId}', name: $('#testInstanceAddTagInput').val(),type: "testInstance" })
                            .success(
                                function(data) {
                                    refreshTableContents('#testInstance', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });
            <!-- end of section of JS for adding new tags -->

            <!-- section of JS for adding new tags -->
            $('#defectAddTag').button({icons: {primary: 'ui-icon-plus'}});
            $("#defectAddTag").click(function(){
                $('#defectAddTagDialog').dialog("open");
            });

            $('#defectAddTagDialog').dialog({

            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function(){
                    $.post('@{admin.Projects.addTag()}', {projectId:'${projectId}', name: $('#defectAddTagInput').val(),type: "defect" })
                            .success(
                                function(data) {
                                    refreshTableContents('#defect', false);
                                    disableRenameAndDeleteButtons();
                                    $(this).dialog("close");
                                })
                            .error(errorHandler);

                    $(this).dialog("close");
                },
                "Cancel": function(){
                    $(this).dialog("close");
                }
            }
            });
            <!-- end of section of JS for adding new tags -->

            <!-- section of JS for deletion of tags -->

            $('#requirementDeleteTag').button({icons: {primary: 'ui-icon-trash'}, disabled: true});
            $("#requirementDeleteTag").click(function(){
                $.post('@{admin.Projects.deleteTag()}', {tagId: getSelectedRowId('#requirement'), type:'requirement'}, function(){
                    refreshTableContents('#requirement', false);
                    disableRenameAndDeleteButtons();
                }).error(errorHandler);
            });

            $('#testScriptDeleteTag').button({icons: {primary: 'ui-icon-trash'}, disabled: true});
            $("#testScriptDeleteTag").click(function(){
                $.post('@{admin.Projects.deleteTag()}', {tagId: getSelectedRowId('#testScript'), type:'testScript'}, function(){
                    refreshTableContents('#testScript', false);
                    disableRenameAndDeleteButtons();
                }).error(errorHandler);
            });

            $('#testInstanceDeleteTag').button({icons: {primary: 'ui-icon-trash'}, disabled: true});
            $("#testInstanceDeleteTag").click(function(){
                $.post('@{admin.Projects.deleteTag()}', {tagId: getSelectedRowId('#testInstance'), type:'testInstance'}, function(){
                    refreshTableContents('#testInstance', false);
                    disableRenameAndDeleteButtons();
                }).error(errorHandler);
            });

            $('#defectDeleteTag').button({icons: {primary: 'ui-icon-trash'}, disabled: true});
            $("#defectDeleteTag").click(function(){
                $.post('@{admin.Projects.deleteTag()}', {tagId: getSelectedRowId('#defect'), type:'defect'}, function(){
                    refreshTableContents('#defect', false);
                    disableRenameAndDeleteButtons();
                }).error(errorHandler);
            });

            <!-- end ofsection of JS for deletion of tags -->

            <!-- function for disabling all rename and delete buttons -->

            function disableRenameAndDeleteButtons(){
                $("#requirementDeleteTag").button("disable");
                $("#requirementRenameTag").button("disable");
                $("#testScriptDeleteTag").button("disable");
                $("#testScriptRenameTag").button("disable");
                $("#testInstanceDeleteTag").button("disable");
                $("#testInstanceRenameTag").button("disable");
                $("#defectDeleteTag").button("disable");
                $("#defectRenameTag").button("disable");
            }

            $(document).ready(function() {

                

                #{tabularasa.init tableId:'requirement'}
                var requirementParameters = {
                  "aoColumns": [
                    {"sName": "id", "sClass": "sNone" },
                    {"sName": "name"}
                  ],
                  "sAjaxSource": '@{admin.Projects.tagsData().add("projectId", projectId).add("tagType", 0)}',
                  "bProcessing": false,
                  "bServerSide": true,
                  "bLengthChange": false,
                  "bSort": false,
                  "iDisplayLength": false,
                  "bInfo": false,
                  "bFilter":true,
                  "oLanguage": {
                    "sZeroRecords": "No tags created yet"
                  }
                };
                #{/tabularasa.init}

                #{tabularasa.init tableId:'testScript'}
                var testScriptParameters = {
                  "aoColumns": [
                    {"sName": "id", "sClass": "sNone" },
                    {"sName": "name"}
                  ],
                  "sAjaxSource": '@{admin.Projects.tagsData().add("projectId", projectId).add("tagType", 1)}',
                  "bProcessing": false,
                  "bServerSide": true,
                  "bLengthChange": false,
                  "bSort": false,
                  "iDisplayLength": false,
                  "bInfo": false,
                  "bFilter":true,
                  "oLanguage": {
                    "sZeroRecords": "No tags created yet"
                  }
                };
                #{/tabularasa.init}

                #{tabularasa.init tableId:'testInstance'}
                var testInstanceParameters = {
                  "aoColumns": [
                    {"sName": "id", "sClass": "sNone" },
                    {"sName": "name"}
                  ],
                  "sAjaxSource": '@{admin.Projects.tagsData().add("projectId", projectId).add("tagType", 2)}',
                  "bProcessing": false,
                  "bServerSide": true,
                  "bLengthChange": false,
                  "bSort": false,
                  "iDisplayLength": false,
                  "bInfo": false,
                  "bFilter":true,
                  "oLanguage": {
                    "sZeroRecords": "No tags created yet"
                  }
                };
                #{/tabularasa.init}


                #{tabularasa.init tableId:'defect'}
                var defectParameters = {
                  "aoColumns": [
                    {"sName": "id", "sClass": "sNone" },
                    {"sName": "name"}
                  ],
                  "sAjaxSource": '@{admin.Projects.tagsData().add("projectId", projectId).add("tagType", 3)}',
                  "bProcessing": false,
                  "bServerSide": true,
                  "bLengthChange": false,
                  "bSort": false,
                  "iDisplayLength": false,
                  "bInfo": false,
                  "bFilter":true,
                  "oLanguage": {
                    "sZeroRecords": "No tags created yet"
                  }
                };
                #{/tabularasa.init}
            });


        </script>

#{/else}
