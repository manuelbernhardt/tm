#{extends 'main.html' /}
#{set title:'Test execution' /}

<div style="float:right;">
    <select id='filterSelect' data-bind="options:availableFilters,
                                         optionsValue: 'filterId',
                                         optionsText: 'name',
                                         optionsCaption: 'Filter' ">
    </select>
</div>
<br/>
<br/><div id="filter_container" style="display:none">
#{box 'Filters'}
#{include 'Execution/filter.html'/}
#{/box}
<br/>
</div>
<div id="filterSaveDialog" style="display:none;" title="Enter a name of the filter">
    <input id="filterName" />
</div>

<div class="container ui-widget-content">

  <div class="left_table">

    <table class="display" id="instanceTable">
      <thead>
      <tr>
        <th>Tags</th>
        <th>Test instance</th>
        <th>Status</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

  <div class="right_table">
    <div id="content">

      #{box 'Runs for test instance'}

      #{deadbolt.restrict roles:[[models.general.UnitRole.TESTEXECCREATE]]}
        <div id="createRunButton">Run Test Instance</div>
      #{/deadbolt.restrict}
      #{deadbolt.restrict roles:[[models.general.UnitRole.TESTEXECEDIT]]}
        <div id="updateRunButton">Edit Test Run</div>
      #{/deadbolt.restrict}
      #{deadbolt.restrict roles:[[models.general.UnitRole.TESTEXECDELETE]]}
      <div id="deleteRunButton">Delete Test Run</div>
      #{/deadbolt.restrict}

      <div id="createRunDialog" title="Run Test Instance"></div>
      <div id="updateRunDialog" title="Update Test Run"></div>
      <div id="deleteRunDialog" title="Delete Test Run"></div>
      <div id="createDefectDialog" title="Create a defect ?">
          This test run failed, do you want to create a defect ?
      </div>

      <table class="display" id="runTable">
        <thead>
        <tr>
          <th>Execution date</th>
          <th>Tester</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="runContent">
        <table class="display" id="runStepTable">
          <thead>
          <tr>
            <th>Nr</th>
            <th>Name</th>
            <th>Description</th>
            <th>Expected results</th>
            <th>Actual results</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      #{/box}

    </div>
  </div>

</div>


<script type="text/javascript">
  $(document).ready(function() {

    var fullDrawInstanceTable = true;
    var fullDrawRunTable = true;

    #{tabularasa.init tableId:'instanceTable'}
    var instanceTableParameters = {
      "aoColumns": [
        {"sName": "id", "sClass": "sNone" },
        {"sName": "tagNames"},
        {"sName": "name"},
        {"sName": "executionStatus"}
      ],
      "sAjaxSource": "@{Execution.instances()}",
      "bProcessing": false,
      "bServerSide": true,
      "bLengthChange": false,
      "bSort": false,
      "bFilter": false,
      "iDisplayLength": 10,
      "bAutoWidth": false,
      "bInfo": false,
      "oLanguage": {
        "sZeroRecords": "No test instances found"
      },
      "fnDrawCallback": function() {
        refreshTableContents('#runTable', fullDrawInstanceTable);
        fullDrawInstanceTable = true;
      }
    };
    #{/tabularasa.init}

    #{tabularasa.init tableId:'runTable'}
    var runTableParameters = {
      "aoColumns": [
        {"sName": "id", "sClass": "sNone" },
        {"sName": "executionDate", "fnRender": function ( oObj ) { return $.format.date(oObj.aData[1], "${play.Play.configuration.getProperty('datetime.format')}"); }},
        {"sName": "tester.fullName"},
        {"sName": "executionStatus"}
      ],
      "aoSorting": [
        [0, "desc"]
      ],
      "sAjaxSource": "@{Execution.runs()}",
      "bProcessing": false,
      "bServerSide": true,
      "bLengthChange": false,
      "bSort": false,
      "bFilter": false,
      "iDisplayLength": 10,
      "bAutoWidth": false,
      "bInfo": false,
      "oLanguage": {
        "sZeroRecords": "No runs performed yet"
      },
      "fnDrawCallback": function() {
        refreshTableContents('#runStepTable', fullDrawRunTable);
        fullDrawRunTable = true;
      }
    };
    #{/tabularasa.init}

    #{tabularasa.init tableId:'runStepTable'}
    var runStepTableParameters = {
      "aoColumns": [
        {"sName": "id", "sClass": "sNone" },
        {"sName": "position"},
        {"sName": "name"},
        {"sName": "descriptionHTML"},
        {"sName": "expectedResultHTML"},
        {"sName": "actualResult"},
        {"sName": "executionStatus"}
      ],
      "sAjaxSource": "@{Execution.runSteps()}",
      "bProcessing": false,
      "bServerSide": true,
      "bLengthChange": false,
      "bSort": false,
      "bFilter": false,
      "iDisplayLength": 10,
      "bInfo": false,
      "bAutoWidth": false,
      "oLanguage": {
        "sZeroRecords": "No run steps defined"
      }
    };
    #{/tabularasa.init}

    function addRequestParameters(parameters, tableId) {
      if (tableId == 'instanceTable') {
        parameters.push({"name": "cycle", "value": $('#cycle option:selected').val() });
        parameters.push({"name": "status", "value": $('#status option:selected').val() });
        parameters.push({"name": "tags", "value": $('#tags').val() });
        parameters.push({"name": "responsible", "value": $('#responsible option:selected').val() });
        parameters.push({"name": "dateFrom", "value": $('#dateFrom').val() });
        parameters.push({"name": "dateTo", "value": $('#dateTo').val() });
      }
      if (tableId == 'runTable') {
        parameters.push({"name": "instanceId", "value": getSelectedRowId('#instanceTable')});
      }
      if (tableId == 'runStepTable') {
        parameters.push({"name": "runId", "value": getSelectedRowId('#runTable')});
      }
    }

    handleRowSelection('#instanceTable', function(selectedRowId) {
      $('#createRunButton').button('enable');
      fullDrawRunTable = true;
      refreshTableContents('#runTable', true);
    });

    handleRowSelection('#runTable', function(selectedRowId) {
      $('#updateRunButton').button('enable');
      $('#deleteRunButton').button('enable');
      refreshTableContents('#runStepTable', true);
    });

    $('#createRunButton').button({disabled: true}).click(function() {
      $('#createRunDialog').dialog('open')
    });

    $('#createRunDialog').dialog({
      autoOpen: false,
      width: 800,
      height: 'auto',
      draggable: true,
      resizable: false,
      modal: true,
      open: function() {
        $('#createRunDialog').load('@{Execution.createRunDialog}', { instanceId: getSelectedRowId('#instanceTable') });
      },
      buttons: {
        "Save": function() {
          $('#runForm').ajaxSubmit({
             success: function(data) {
               fullDrawInstanceTable = false;
               refreshTableContents('#instanceTable', false);
               $('#createRunDialog').dialog("close");
               if(data.length > 0){
                 createdRunId = data;
                 $('#createDefectDialog').dialog("open");
               }
              },
             error: function(xhr, textStatus, errorThrown) {
               errorHandler(xhr, textStatus, errorThrown);
               $('#createRunDialog').dialog("close");
             }
           });
        },
        "Cancel": function() {
          $(this).dialog("close");
        }
      }
    });

    $('#updateRunButton').button({icons: {primary: 'ui-icon-pencil'}, disabled: true}).click(function() {
      $('#updateRunDialog').dialog('open')
    });

    $('#updateRunDialog').dialog({
      autoOpen: false,
      width: 800,
      height: 'auto',
      draggable: true,
      resizable: false,
      modal: true,
      open: function() {
        $('#updateRunDialog').load('@{Execution.updateRunDialog}', { runId: getSelectedRowId('#runTable') });
      },
      buttons: {
        "Save": function() {
          $('#runForm').ajaxSubmit({
            success: function(data) {
              fullDrawInstanceTable = false;
              refreshTableContents('#instanceTable', false);
              $('#updateRunDialog').dialog("close");
              if(data.length > 0) {
                createdRunId = data;
                $('#createDefectDialog').dialog("open");
              }
            },
            error: function(xhr, textStatus, errorThrown) {
               errorHandler(xhr, textStatus, errorThrown);
              $('#updateRunDialog').dialog("close");
            }
          });
        },
        "Cancel": function() {
          $(this).dialog("close");
        }
      }
    });

    $('#deleteRunButton').button({icons: {primary: 'ui-icon-trash'}, disabled: true}).click(function() {
      $('#deleteRunDialog').dialog('open');
    });

    $('#deleteRunDialog').dialog({
        autoOpen: false,
        height: 100,
        width: 300,
        modal: true,
        buttons: {
            "Confirm": function() {
                $.ajax({
                  type: 'POST',
                  url: '@{Execution.deleteRun()}',
                  data: {runId: getSelectedRowId('#runTable')},
                  success: function() {
                    refreshTableContents('#instanceTable', false);
                    $('#deleteRunDialog').dialog("close");
                  },
                  error: function(xhr, textStatus, errorThrown) {
                    errorHandler(xhr, textStatus, errorThrown);
                    refreshTableContents('#instanceTable', false);
                    $('#deleteRunDialog').dialog("close");
                  }
                });
            },
            "Cancel": function() {
                $(this).dialog("close");
            }

        }
    });


  });

  $('#createDefectDialog').dialog({
      autoOpen: false,
      width: 300,
      height: 200,
      draggable: true,
      resizable: false,
      modal: true,
      buttons: {
          "Yes": function(){
            $.ajax({
                type: 'POST',
                url: '@{Execution.createDefect()}',
                data: {id: createdRunId},
                success: function(data){
                    $(this).dialog("close");
                    window.location="/defects/"+data+"/edit";
                },
                error: errorHandler
            })
          },
          "No": function(){
              $(this).dialog("close");
          }
      }
  });

  //hack for creating defect
  var createdRunId = null;


// filter functions

  $('#filterSaveDialog').dialog({
      autoOpen: false,
      height: 200,
      width: 300,
      modal: true,
      buttons: {
          "Confirm": function() {
              var data = {
                "name": $('#filterName').val(),
                "entity": 'tm.models.Instance',
                "constraint['cycle']['value']" : $('#cycle').val(),
                "constraint['status']['value']" : $('#status').val(),
                "constraint['tags']['value']" : $('#tags').val(),
                "constraint['responsible']['value']" : $('#responsible').val(),
                "constraint['dateFrom']['dateFrom']" : $('#dateFrom').val(),
                "constraint['dateTo']['dateTo']" : $('#dateTo').val()
            }

            $.post('@{Execution.saveFilter()}', data).error(errorHandler);
//                    $(this).html("Filter saved successfully").delay(80000);
              //TODO make a fb dialog

              $.getJSON("@{Execution.loadFilters()}", function(json) {

                  var filterData = json;

                  var form =  document.getElementById('filterSelect');
                  if(!ko.mapping.isMapped(viewModelLoadFilters)){
                      viewModelLoadFilters = ko.mapping.fromJS(filterData);
                      ko.applyBindings(viewModelLoadFilters, form);
                      $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
                  }
                  else{
                      ko.mapping.updateFromJS(viewModelLoadFilters,filterData);
                      $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
                  }
              }).error(errorHandler);
              $(this).dialog("close");
          },
          "Cancel": function() {
              $(this).dialog("close");
          }

      }
  });

$('#saveFilter').button().click(function(){
    $('#filterSaveDialog').dialog('open');
});

   var viewModel = {};
   var viewModelLoadFilters = {};

  $('document').ready(function(){
      $.getJSON("@{Execution.loadFilters()}", function(json) {
          var filterData = json;

          var form =  document.getElementById('filterSelect');
          if(!ko.mapping.isMapped(viewModelLoadFilters)){
              viewModelLoadFilters = ko.mapping.fromJS(filterData);
              ko.applyBindings(viewModelLoadFilters, form);
              $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
          }
          else{
              ko.mapping.updateFromJS(viewModelLoadFilters,filterData);
              $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
          }
          }).error(errorHandler);
  });

  $('#filterSelect').button({icons: {primary: 'ui-icon-triangle-1-s'}}).change(function(data){
      $('#filter_container').slideDown('slow');
      var param = {
          id: $(this).val()
      }
      if($(this).val()!=null && $(this).val()!='' && $(this).val()!='customFilter'){
          $.getJSON('@{Execution.loadFilterById()}', param, function(jsonFilter){

              d = jsonFilter;

              var form =  document.getElementById('instanceFilterForm');
              if(!ko.mapping.isMapped(viewModel)){
                  viewModel = ko.mapping.fromJS(d);
                  ko.applyBindings(viewModel, form);
              }
              else{
                  ko.mapping.updateFromJS(viewModel,d);
              }
          }).error(errorHandler);
      }

      if($(this).val()==''){
          $('#filter_container').slideUp('slow');
      }

      //clear the form in case a filter was previously applied

      if($(this).val()=='customFilter'){
          $(':input','#instanceFilterForm')
           .not(':button, :submit, :reset, :hidden')
           .val('')
           .removeAttr('checked')
           .removeAttr('selected');
      }

  });

</script>