#{extends 'main.html' /}
#{set title:'Requirements' /}

<div class="container">
  <div class="left_tree">
    <div id="actions">
      <button id="create_folder">Folder</button>
      <button id="create_requirement">Requirement</button>
      <button id="remove">Remove</button>
    </div>
    <div id="requirementTree" class="tree"></div>
  </div>
  <div class="right_tree">
    <div id="innerTabs">
      <ul>
        <li><a href="#requirementDetails" id="details"><span>Requirement details</span></a></li>
        <li><a href="#linked"><span>Linked entities</span></a></li>
      </ul>
      <div id="requirementDetails">

        #{ox.form action:@Requirements.edit(), id:'requirementForm', baseClass:'models.tm.Requirement',
        loadAction:@Requirements.requirementsDetailsData()}
        #{ox.field field:'requirement.name', label:'Name' /}
        #{ox.field field:'requirement.description', label:'Description' /}
        #{ox.field field:'requirement.type', label:'Type' /}
        *{the following fields are necessary because play can't bind stuff automatically yet}*
        #{ox.field field:'requirement.id', hidden:true /}
        #{ox.field field:'requirement.type.id', hidden:true /}
        #{ox.field field:'requirement.project.id', hidden:true /}
        #{ox.field field:'requirement.project.account.id', hidden:true /}
        #{ox.field field:'requirement.project.projectCategory.id', hidden:true /}
        #{ox.field field:'requirement.project.projectCategory.account.id', hidden:true /}
        #{input.submit /}
        #{/ox.form}

      </div>
      <div id="linked">

      </div>
    </div>
  </div>
</div>


#{set 'moreScripts'}
<script type="text/javascript">

  $(document).ready(function () {

    $('#requirementForm').initForm({
      id: 1,
      loadAction: '@{Requirements.requirementsDetailsData()}',
      submissionCallback: function() {
        refreshTree('requirementTree');
      }
    });


    $('#create_folder').button({icons: {primary: 'ui-icon-plus'}});
    $('#create_requirement').button({icons: {primary: 'ui-icon-plus'}});
    $('#remove').button({icons: {primary: 'ui-icon-minus'}});


    $("#innerTabs").tabs({
      select: function() {
        removeDialogs();
      }
    });

    var tree = $("#requirementTree").jstree({
      "plugins" : [ "json_data", "ui", "crrm",  "types", "contextmenu", "hotkeys", "themeroller" ],

      "json_data" : {
        "ajax" : {
          "url" : "@{TMTreeController.getChildren()}",
          "data" : function (n) {
            return {
              "id" : n.attr ? n.attr("id").replace("node_", "") : -1,
              "treeId" : "requirementTree"
            };
          }
        }
      },
      "themeroller": {
        "item": ""
      },
      "types" : {
        "max_depth" : -2,
        "max_children" : -2,
        "types" : {
          "default" : {
            "valid_children" : "none",
            "icon" : {
              "image" : "@{'public/images/jstree/file.png'}" // TODO icon for requirement
            }
          },
          "requirementFolder" : {
            "valid_children" : [ "default", "requirementFolder" ],
            "icon" : {
              "image" : "@{'public/images/jstree/folder.png'}"
            },
            "start_drag" : false,
            "move_node" : false,
            "delete_node" : true,
            "remove" : true
          }
        }
      },
      "hotkeys": {
        "Ctrl+x" : function() {
          this.cut(null)
        },
        "Ctrl+v" : function() {
          this.paste(null)
        },
        "Ctrl+n" : function() {
          this.create_node(null, "after", {attr:{"rel":"default"}});
        }
      }
    });

    #{tree.common id:"requirementTree", controller:"TMTreeController" /}

    /** Selection listener **/
    $("#requirementTree").bind("select_node.jstree", function (e, data) {
      var tabLinks = ['@{Requirements.requirementDetails()}', '@{Requirements.linked()}'];
      treeNodeSelectionHandler(tabLinks, ['default', 'requirement'], 'requirement', $('#innerTabs'), data);
    });


    /** button initialisation **/
    $(function () {
      $("#create_folder").click(function () {
        $("#requirementTree").jstree("create", null, "last", {attr:{"rel":"requirementFolder"}});
      })
      $("#create_requirement").click(function () {
        $("#requirementTree").jstree("create", null, "last", {attr:{"rel":"default"}});
      })
      $("#remove").click(function () {
        $("#requirementTree").jstree("remove", null);
      })
    });

  });

</script>
#{/set}
