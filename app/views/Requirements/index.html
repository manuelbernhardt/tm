#{extends 'main.html' /}
#{set title:'Requirements' /}


<div class="container">
    <div id="actions" class="actions">
        <div class="actions buttons" style="width:30%">
            #{deadbolt.restrict roles:[[models.general.UnitRole.REQCREATE]]}
            <button id="create_folder" style="margin-right:-0.1em">Create new folder</button>
            <button id="create_requirement" style="margin-right:-0.1em">Create new requirement</button>
            <button id="import_requirements" style="margin-right:-0.1em">Import requirements</button>
            <div id="importRequirementsDialog">
              Here will come an upload dialog
            </div>
            #{/deadbolt.restrict}
            #{deadbolt.restrict roles:[[models.general.UnitRole.REQDELETE]]}
            <button id="remove">Remove</button>
            #{/deadbolt.restrict}
        </div>
    </div>
    <div class="tree-container">
        <div class="left_tree">

            #{box 'Requirements'}
            <div id="searchBox" class="searchBox" >
                    <input id="searchInput" class="searchInput" type="text">
            </div>
            <div id="requirementTree" class="tree" style="border-style:none;">

            </div>
            #{/box}
        </div>
        <div class="right_tree">
            <div id="innerTabs">
                <ul>
                    <li><a href="#requirementDetails" id="details"><span>Requirement details</span></a></li>
                    <li><a href="#linked"><span>Linked entities</span></a></li>
                </ul>
                <div id="requirementDetails">
                    <div class="hiddenOnLoad">
                        #{ox.form action:@Requirements.edit(), edit:util.Require.roles([[models.general.UnitRole.REQEDIT]]),
                        id:'requirementForm', baseClass:'models.tm.Requirement'}
                        #{ox.field field:'requirement.name', label:'Name' /}
                        #{ox.field field:'requirement.description', label:'Description' /}
                        #{ox.field field:'requirement.tags', label:'Tags', type:'tags' /}
                        *{the following fields are necessary because play can't bind stuff automatically yet}*
                        #{ox.field field:'requirement.id', hidden:true /}
                        #{ox.field field:'requirement.account.id', hidden:true /}
                        #{ox.field field:'requirement.project.id', hidden:true /}
                        #{ox.field field:'requirement.project.account.id', hidden:true /}
                        #{ox.field field:'requirement.project.projectCategory.id', hidden:true /}
                        #{ox.field field:'requirement.project.projectCategory.account.id', hidden:true /}
                        #{ox.submit /}
                        #{/ox.form}
                    </div>
                    <div class="shownOnLoad">
                        No requirement selected.
                    </div>

                </div>
                <div id="linked">
                    <div class="hiddenOnLoad">
                        #{include 'Requirements/linkedEntities.html' /}
                    </div>
                    <div class="shownOnLoad">
                        No requirement selected.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


#{set 'moreScripts'}

<script type="text/javascript">

    $(document).ready(function () {

        $("#innerTabs").tabs();

        $('.oxdisplayfield').removeClass('field');

        $("#requirementTree").tree({types: requirementTreeTypes, onRename: function(name) {
            var fieldName = '#' + $('#requirementForm').oxForm('getFieldId', 'requirement.name');
            $(fieldName).val(name);
        }
        });

        $('#requirementForm').oxForm({
            loadAction: '@{Requirements.requirementsDetailsData()}',
            submissionCallback: function() {
                refreshTree('requirementTree');
            }
        });

        #{deadbolt.restrict roles:[[models.general.UnitRole.REQCREATE], [models.general.UnitRole.REQEDIT]]}
        // tags
        var tokens = $('#requirementForm_requirement_tags').tokenInput({
            url: '@{Requirements.allTags()}',
            preventDuplicates: true,
            tokenValue: 'name',
            allowCreation: true,
            creationText: "Create new tag"
        });
        #{/deadbolt.restrict}

        $("#requirementTree").bind("select_node.jstree", function (e, data) {
            if (isSelectedNodeType(data, ["requirement", "default"])) {
                $('.shownOnLoad').hide();
                $('.hiddenOnLoad').show();

                var requirementId = getSelectedNodeId('requirementTree');
                $('#requirementForm').oxForm('load', requirementId);

                reloadTables();
            }
        });

        $('#create_folder').button({icons: {primary: 'ui-icon-plus', secondary: 'ui-icon-folder-open'}, text: false}).click(function () {
            $("#requirementTree").jstree("create", null, "last", {attr:{"rel":"requirementFolder"}, data:"New folder"});
        });
        $('#create_requirement').button({icons: {primary: 'ui-icon-plus', secondary: 'ui-icon-flag'}, text: false}).click(function () {
            $("#requirementTree").jstree("create", null, "last", {attr:{"rel":"default"}, data:"New requirement"});
        });
        $('#remove').button({icons: {primary: 'ui-icon-minus'}, text: false}).click(function () {
            $("#requirementTree").jstree("remove", null);
        });

        $('#import_requirements').button().click(function() {
          $('#importRequirementsDialog').dialog('open');
        });

        $('#importRequirementsDialog').dialog({
          autoOpen: false,
          height: 300,
          width: 400,
          modal: true,
          title: 'Import Requirements from Excel file',
          buttons: {
            "Upload": function() {
              $(this).dialog('close');
            },
            Cancel: function() {
              $(this).dialog('close');
            }
          }
        });

      $('#searchInput').keyup(function() {
        $("#requirementTree").jstree("search", $(this).val());
      });

    });

</script>
#{/set}
