#{extends 'main.html' /}
#{set title:'Defects' /}

#{deadbolt.restrict roles:[[models.general.UnitRole.DEFECTCREATE]]}
    <button id="createDefectButton">Create defect</button>
    <button id="updateDefectButton">Update defect</button>
#{/deadbolt.restrict}

<div id="createDefectDialog" title="Create a defect">
  #{ox.form id:'createDefectForm', action:@Defects.createDefect(), baseClass:'models.tm.Defect', create:true}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
  #{/ox.form}
</div>

<div id="updateDefectDialog" title="Create a defect">
  #{ox.form id:'updateDefectForm', action:@Defects.updateDefect(), baseClass:'models.tm.Defect'}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
    #{ox.field field:'defect.id', hidden:true/}
  #{/ox.form}
</div>


<table class="display" id="defectsTable">
  <thead>
  <tr>
    <th>ID</th>
    <th>Summary</th>
    <th>Tags</th>
    <th>Assigned To</th>
    <th>Raised By</th>
    <th>Status</th>
  </tr>
  </thead>
  <tbody></tbody>
</table>


<script type="text/javascript">

    #{tabularasa.init tableId:'defectsTable'}
        var defectsTableParameters = {
            "aoColumns":[
                {"sName": "id"},
                {"sName": "name"},
                {"sName": "tagNames"},
                {"sName": "assignedTo"},
                {"sName": "submittedBy"},
                {"sName": "status"}
            ],
            "bServerSide": true,
            "bLengthChange": false,
            "bSort": false,
            "bFilter": false,
            "iDisplayLength": 10,
            "bInfo": false,
            "sAjaxSource": "@{Defects.defects()}",
            "oLanguage": {
                "sZeroRecords": "No defects reported"
            }
        };
    #{/tabularasa.init}

    // creating a defect
    $('#createDefectButton').button({icons: {primary: 'ui-icon-plus'}});
    $('#createDefectButton').click(function(){
        $('#createDefectDialog').dialog('open');
    });

    $('#createDefectForm').oxForm({
      submissionCallback: function() {
        refreshTableContents("defectsTable", false);
      }
    });

    $('#createDefectDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      buttons: {
        "Create defect": function() {
          $('#createDefectForm').oxForm('submitCreateForm');
          $(this).dialog("close");
        },
        "Cancel": function() {
          $('#createDefectForm').resetForm();
          $(this).dialog("close");
        }
      }
    });

    //updating a defect

    handleRowSelection('#defectsTable', function() {
      $('#updateDefectButton').button('enable');
    });

    $('#updateDefectForm').oxForm({
      submissionCallback: function() {
        refreshTableContents("defectsTable", false);
      },
      loadAction: '@{Defects.defectDetails()}'
    });

    $('#updateDefectButton').button({icons: {primary: 'ui-icon-pencil'}});
    $('#updateDefectButton').button('disable');
    $('#updateDefectButton').click(function() {
      $('#updateDefectDialog').dialog('open');
    });

    $('#updateDefectDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      open: function(){
          $('#updateDefectForm').oxForm('load', getSelectedRowId('#defectsTable'));
      },
      buttons: {
        "Update defect": function() {
          $('#updateDefectForm').submit();
          $(this).dialog("close");
        },
        "Cancel": function() {
          $('#updateDefectForm').resetForm();
          $(this).dialog("close");
        }
      }
    });



</script>