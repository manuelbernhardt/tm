#{extends 'main.html' /}
#{set title:'Defects' /}

#{deadbolt.restrict roles:[[models.general.UnitRole.DEFECTCREATE]]}
    <button id="createDefectButton">Submit a defect</button>
#{/deadbolt.restrict}

#{box 'Filters'}
#{include 'Defects/filter.html'/}
#{/box}

<div id="createDefectDialog" title="Create a defect">
  #{ox.form id:'createDefectForm', action:@Defects.createDefect(), baseClass:'models.tm.Defect', create:true}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.description', label:'Description'/}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
  #{/ox.form}
</div>

<div id="updateDefectDialog" title="Update a defect">
  #{ox.form id:'updateDefectForm', action:@Defects.updateDefect(), baseClass:'models.tm.Defect'}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.description', label:'Description'/}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
    #{ox.field field:'defect.id', hidden:true/}
  #{/ox.form}
</div>

<br/>
#{box 'Defects'}
    <table class="display" id="defectsTable">
      #{deadbolt.restrict roles:[[models.general.UnitRole.DEFECTCREATE]]}
        <button id="updateDefectButton">Update defect</button>
      #{/deadbolt.restrict}
      <thead>
      <tr>
        <th>ID</th>
        <th>Summary</th>
        <th>Tags</th>
        <th>Assigned To</th>
        <th>Raised By</th>
        <th>Status</th>
        <th>Submitted at</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
#{/box}


<script type="text/javascript">

    //table definition

    #{tabularasa.init tableId:'defectsTable'}
        var defectsTableParameters = {
            "aoColumns":[
                {"sName": "id", "sClass": "sNone"},
                {"sName": "naturalId"},
                {"sName": "name", "bSortable": false},
                // jquery datatable bug, bSortable works as a switch here, turn it off before tagNames and switch it on after, thus tagName is not sortable
                {"sName": "tagNames", "bSortable": true},
                {"sName": "assignedTo"},
                {"sName": "submittedBy"},
                {"sName": "status.name"},
                {"sName": "created", "fnRender": function ( oObj ) { return $.format.date(oObj.aData[7], "${play.Play.configuration.getProperty('datetime.format')}"); }}
            ],
            "bServerSide": true,
            "bLengthChange": false,
            "bSort": true,
            "bFilter": false,
            "iDisplayLength": 10,
            "bInfo": false,
            "sAjaxSource": "@{Defects.defects()}",
            "oLanguage": {
                "sZeroRecords": "No defects reported"
            }
        };
    #{/tabularasa.init}

    //adding request parameters for a given table

    function addRequestParameters(parameters, tableId) {
      if (tableId == 'defectsTable') {
        parameters.push({"name": "title", "value": $('#title').val() });
        parameters.push({"name": "titleCase", "value": $('#titleCase option:selected').val() });
        parameters.push({"name": "tags", "value": $('#tags').val() });
        parameters.push({"name": "status", "value": $('#status option:selected').val() });
        parameters.push({"name": "assignedToId", "value": $('#assignedToId option:selected').val() });
        parameters.push({"name": "submittedById", "value": $('#submittedById option:selected').val() });
        parameters.push({"name": "dateFrom", "value": $('#dateFrom').val() });
        parameters.push({"name": "dateTo", "value": $('#dateTo').val() });
      }
      
    }

    // creating a defect
    $('#createDefectButton').button({icons: {primary: 'ui-icon-plus'}});
    $('#createDefectButton').click(function(){
        $('#createDefectDialog').dialog('open');
    });

    $('#createDefectForm').oxForm({
      submissionCallback: function() {
        refreshTableContents('#defectsTable', false);
      }
    });

    $('#createDefectDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      buttons: {
        "Create defect": function() {
          $('#createDefectForm').oxForm('submitCreateForm');
          $(this).dialog("close");
        },
        "Cancel": function() {
          $('#createDefectForm').resetForm();
          $(this).dialog("close");
        }
      }
    });

    //updating a defect

    handleRowSelection('#defectsTable', function() {
      $('#updateDefectButton').button('enable');
    });

    $('#updateDefectForm').oxForm({
      submissionCallback: function() {
        refreshTableContents('#defectsTable', false);
      },
      loadAction: '@{Defects.defectDetails()}'
    });

    $('#updateDefectButton').button({icons: {primary: 'ui-icon-pencil'}});
    $('#updateDefectButton').button('disable');
    $('#updateDefectButton').click(function() {
      $('#updateDefectDialog').dialog('open');
    });

    $('#updateDefectDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      open: function(){
          $('#updateDefectForm').oxForm('load', getSelectedRowId('#defectsTable'));
      },
      buttons: {
        "Update defect": function() {
          $('#updateDefectForm').submit();
          $(this).dialog("close");
        },
        "Cancel": function() {
          $('#updateDefectForm').resetForm();
          $(this).dialog("close");
        }
      }
    });



</script>