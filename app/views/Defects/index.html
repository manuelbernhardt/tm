#{extends 'main.html' /}
#{set title:'Defects' /}


<!--<button id="filter_button">Filter</button>-->

<div style="float:right;">
    <select id='filterSelect' data-bind="options:availableFilters,
                                         optionsValue: 'filterId',
                                         optionsText: 'name',
                                         optionsCaption: 'Filter' ">
    </select>
</div>
<br/>
<br/>
<div id="filter_container">

    #{box 'Filters'}
    #{include 'Defects/filter.html'/}
    #{/box}
    <br/>
</div>


#{deadbolt.restrict roles:[[models.general.UnitRole.DEFECTCREATE]]}
<button id="createDefectButton">Submit a defect</button>
<button id="updateDefectButton">Update defect</button>
#{/deadbolt.restrict}

#{deadbolt.restrict roles:[[models.general.UnitRole.DEFECTDELETE]]}
<button id="deleteDefectButton">Delete defect</button>
#{/deadbolt.restrict}


<div id="createDefectDialog" style="display:none" title="Create a defect">
    #{box 'Submit a defect'}
    #{ox.form id:'createDefectForm', action:@Defects.createDefect(), baseClass:'models.tm.Defect', create:true}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.description', label:'Description'/}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
    #{ox.field field:'defect.tags', label:'Tags', type:'tags' /}
    #{/ox.form}
    <button id="createDefectConfirm">Submit</button>
    <button id="createDefectCancel">Cancel</button>
    #{/box}
</div>

<div id="updateDefectDialog" style="display:none" title="Update a defect">
    #{box 'Update the defect'}
    #{ox.form id:'updateDefectForm', action:@Defects.updateDefect(), baseClass:'models.tm.Defect'}
    #{ox.field field:'defect.name', label:'Summary' /}
    #{ox.field field:'defect.description', label:'Description'/}
    #{ox.field field:'defect.assignedTo', label:'Assign to' /}
    #{ox.field field:'defect.status', label:'Status' /}
    #{ox.field field:'defect.tags', label:'Tags', type:'tags' /}
    #{ox.field field:'defect.id', hidden:true/}
    #{/ox.form}
    <button id="updateDefectConfirm">Submit</button>
    <button id="updateDefectCancel">Cancel</button>
    #{/box}
</div>

<div id="deleteDefectDialog" style="display:none;" title="Confirm deletion of defect"></div>

<div id="filterSaveDialog" style="display:none;" title="Enter a name of the filter">
    <input id="filterName" />
</div>

<!--<div id="filterLoadDialog" style="display:none;" title="Load filter">-->
    <!--#{list items:filterList, as:'filter'}-->
        <!--${filter.name}-->
    <!--#{/list}-->
<!--</div>-->

<br/>
#{box 'Defects'}
<table class="display" id="defectsTable">

    <thead>
    <tr>
        <th>ID</th>
        <th>Summary</th>
        <th>Tags</th>
        <th>Assigned To</th>
        <th>Raised By</th>
        <th>Status</th>
        <th>Submitted at</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
#{/box}


<script type="text/javascript">

//table definition

#{tabularasa.init tableId:'defectsTable'}
var defectsTableParameters = {
    "aoColumns":[
        {"sName": "id", "sClass": "sNone"},
        {"sName": "naturalId"},
        {"sName": "name", "bSortable": false},
        // jquery data table bug, bSortable works as a switch here, turn it off before tagNames and switch it on after, thus tagName is not sortable
        {"sName": "tagNames", "bSortable": true},
        {"sName": "assignedTo"},
        {"sName": "submittedBy"},
        {"sName": "status.name"},
        {"sName": "created", "fnRender": function (oObj) {
            return $.format.date(oObj.aData[7], "${play.Play.configuration.getProperty('datetime.format')}");
        }}
    ],
    "bServerSide": true,
    "bLengthChange": false,
    "bSort": true,
    "bFilter": false,
    "bAutoWidth": false,
    "iDisplayLength": 10,
    "bInfo": false,
    "sAjaxSource": "@{Defects.defects()}",
    "oLanguage": {
        "sZeroRecords": "No defects reported"
    }
};
#{/tabularasa.init}

//adding request parameters for a given table

function addRequestParameters(parameters, tableId) {
    if (tableId == 'defectsTable') {
        parameters.push({"name": "title", "value": $('#title').val() });
        parameters.push({"name": "titleCase", "value": $('#titleCase option:selected').val() });
        parameters.push({"name": "tags", "value": $('#tags').val() });
        parameters.push({"name": "status", "value": $('#status option:selected').val() });
        parameters.push({"name": "assignedToId", "value": $('#assignedToId option:selected').val() });
        parameters.push({"name": "submittedById", "value": $('#submittedById option:selected').val() });
        parameters.push({"name": "dateFrom", "value": $('#dateFrom').val() });
        parameters.push({"name": "dateTo", "value": $('#dateTo').val() });
    }

}

// creating a defect
$('#createDefectButton').button({icons: {primary: 'ui-icon-carat-1-e'}});
$('#createDefectButton').click(function() {
    if ($("#createDefectButton span.ui-icon").hasClass("ui-icon-carat-1-s")) {
        $("#createDefectButton span.ui-icon").addClass("ui-icon-carat-1-e").removeClass("ui-icon-carat-1-s");
    }
    else {
        $("#createDefectButton span.ui-icon").addClass("ui-icon-carat-1-s").removeClass("ui-icon-carat-1-e");
        $('#createDefectForm_defect_tags').tokenInput('clearAll');
    }

    $('#createDefectDialog').slideToggle('slow');
});

$('#createDefectForm').oxForm({
    submissionCallback: function() {
        refreshTableContents('#defectsTable', false);
    }

});

$('#createDefectConfirm').click(function() {
    $('#createDefectForm').oxForm('submitCreateForm');
    $('#createDefectDialog').slideUp('slow');
    $("#createDefectButton span.ui-icon").addClass("ui-icon-carat-1-e").removeClass("ui-icon-carat-1-s");
});
$('#createDefectCancel').click(function() {
    $('#createDefectForm').resetForm();
    $('#createDefectForm_defect_tags').tokenInput('clearAll');
    $('#createDefectDialog').slideUp('slow');
    $("#createDefectButton span.ui-icon").addClass("ui-icon-carat-1-e").removeClass("ui-icon-carat-1-s");
});
//    $('#createDefectDialog').dialog({
//      autoOpen: false,
//      width: 500,
//      height: 400,
//      draggable: true,
//      resizable: false,
//      modal: true,
//      buttons: {
//        "Create defect": function() {
//          $('#createDefectForm').oxForm('submitCreateForm');
//          $(this).dialog("close");
//        },
//        "Cancel": function() {
//          $('#createDefectForm').resetForm();
//          $(this).dialog("close");
//        }
//      }
//    });

//updating a defect

handleRowSelection('#defectsTable', function() {
    $('#updateDefectButton').button('enable');
    $('#deleteDefectButton').button('enable');
});


$('#updateDefectForm').oxForm({
    submissionCallback: function() {
        refreshTableContents('#defectsTable', false);
    },
    loadAction: '@{Defects.defectDetails()}'
});

$('#updateDefectButton').button({icons: {primary: 'ui-icon-pencil'}});
$('#updateDefectButton').button('disable');

$('#updateDefectButton').click(function() {
//        if($("#updateDefectButton span.ui-icon").hasClass("ui-icon-carat-1-s")){
//            $("#updateDefectButton span.ui-icon").addClass("ui-icon-carat-1-e").removeClass("ui-icon-carat-1-s");
//        }
//        else{
//            $("#createDefectButton span.ui-icon").addClass("ui-icon-carat-1-s").removeClass("ui-icon-carat-1-e");
//        }

    $('#updateDefectDialog').slideToggle('slow');
    $('#updateDefectForm').oxForm('load', getSelectedRowId('#defectsTable'));
});

$('#updateDefectForm').oxForm({
    submissionCallback: function() {
        refreshTableContents('#defectsTable', false);
    }
});

$('#updateDefectConfirm').click(function() {
    $('#updateDefectDialog').slideUp('slow');
    $('#updateDefectForm').oxForm('submitCreateForm');

});
$('#updateDefectCancel').click(function() {
    $('#updateDefectDialog').slideUp('slow');
});

//    $('#updateDefectButton').click(function() {
//      $('#updateDefectDialog').dialog('open');
//    });
//
//    $('#updateDefectDialog').dialog({
//      autoOpen: false,
//      width: 500,
//      height: 400,
//      draggable: true,
//      resizable: false,
//      modal: true,
//      open: function(){
//          $('#updateDefectForm').oxForm('load', getSelectedRowId('#defectsTable'));
//      },
//      buttons: {
//        "Update defect": function() {
//          $('#updateDefectForm').submit();
//          $(this).dialog("close");
//        },
//        "Cancel": function() {
//          $('#updateDefectForm').resetForm();
//          $(this).dialog("close");
//        }
//      }
//    });

var tokens = $('#createDefectForm_defect_tags').tokenInput({
    url: '@{Defects.allTags()}',
    preventDuplicates: true,
    tokenValue: 'name',
    allowCreation: true,
    creationText: "Create new tag"
});

$('#updateDefectForm_defect_tags').tokenInput({
    url: '@{Defects.allTags()}',
    preventDuplicates: true,
    tokenValue: 'name',
    allowCreation: true,
    creationText: "Create new tag"
});

toggleFilter('#filter_button', '#filter_container');

// delete defect
$('#deleteDefectButton').button({icons: {primary: 'ui-icon-trash'}, disabled:true});
$('#deleteDefectButton').click(function() {
    $('#deleteDefectDialog').dialog("open");
});

$('#deleteDefectDialog').dialog({
    autoOpen: false,
    height: 100,
    width: 300,
    modal: true,
    buttons: {
        "Confirm": function() {
            $.post('@{Defects.deleteDefect()}', {defectId: getSelectedRowId('#defectsTable')},
                    function() {
                        refreshTableContents('#defectsTable', false);
                    }).error(errorHandler, function() {
                        refreshTableContents('#defectsTable', false);
                        $('#deleteDefectDialog').dialog('close');
                    });

            $(this).dialog("close");
        },
        "Cancel": function() {
            $(this).dialog("close");
        }

    }
});

// filter functions

        $('#filterSaveDialog').dialog({
            autoOpen: false,
            height: 200,
            width: 300,
            modal: true,
            buttons: {
                "Confirm": function() {
                    var data = {
                      "name": $('#filterName').val(),
                      "entity": 'tm.models.Defect',
                      "constraint['title']['value']" : $('#title').val(),
                      "constraint['titleCase']['case']" : $('#titleCase').val(),
                      "constraint['status']['value']" : $('#status').val(),
                      "constraint['tags']['value']" : $('#tags').val(),
                      "constraint['assignedToId']['value']" : $('#assignedToId').val(),
                      "constraint['submittedById']['value']" : $('#submittedById').val(),
                      "constraint['dateFrom']['case']" : $('#dateFrom').val(),
                      "constraint['dateTo']['case']" : $('#dateTo').val()
                  }

                  $.post('@{Defects.saveFilter()}', data).error(errorHandler);
//                    $(this).html("Filter saved successfully").delay(80000);
                    //TODO make a fb dialog
                    $(this).dialog("close");
                },
                "Cancel": function() {
                    $(this).dialog("close");
                }

            }
        });

      $('#saveFilter').button().click(function(){
          $('#filterSaveDialog').dialog('open');
      });

//        $('#filterLoadDialog').dialog({
//            autoOpen: false,
//            height: 200,
//            width: 300,
//            modal: true,
//            buttons: {
//                "Cancel": function() {
//                    $(this).dialog("close");
//                }
//
//            }
//        });

//      $('#loadFilter').click(function(){
//          alert();
//
//          $.getJSON("@{Defects.loadFilters()}", function(json) {
//
//
//
//              var htm='';
//              var i;
//              var action='';
//              var id='';
//              for(i=0;i<json.data.length;i++){
//                  id = json.data[i].filterId;
//                  var addition = "<a href='javascript:callAddr()'>"+json.data[i].name+"</a><br/>"
//                  htm=htm+addition;
//              }
//              $('#filterLoadDialog').html(htm);
//          }).error(errorHandler);
//
//          $('#filterLoadDialog').dialog('open');
//      });
//        var d;
//        function callAddr(){
////            var data = {"id": id}
//
//            $.getJSON('@{Defects.loadFilterById(16)}',function(jsonFilter){
//
//                d = jsonFilter;
//                var viewModel = ko.mapping.fromJS(d);
//                var form =  document.getElementById('defectsFilterForm');
//                if(ko.mapping.isMapped(viewModel)){
//                    ko.applyBindings(viewModel, form);
//                }
//                else{
//                    ko.mapping.updateFromJS(viewModel,d);
//                }
//                $('#filterLoadDialog').dialog('close');
//
//            }).error(errorHandler);
//
//        }

        var viewModel = {};
         var viewModelLoadFilters = {};

        $('document').ready(function(){
            $.getJSON("@{Defects.loadFilters()}", function(json) {
                var filterData = json;

                var form =  document.getElementById('filterSelect');
                if(!ko.mapping.isMapped(viewModelLoadFilters)){
                    viewModelLoadFilters = ko.mapping.fromJS(filterData);
                    ko.applyBindings(viewModelLoadFilters, form);
                    $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
                }
                else{
                    ko.mapping.updateFromJS(viewModelLoadFilters,filterData);
                    $('#filterSelect').append("<option value='customFilter'>Custom filter</option>");
                }
        }).error(errorHandler);

        });
        $('#filterSelect').button({icons: {primary: 'ui-icon-triangle-1-s'}}).change(function(data){
            $('#filter_container').slideDown('slow');
            var param = {
                id: $(this).val()
            }
            if($(this).val()!=null && $(this).val()!='' && $(this).val()!='customFilter'){
                $.getJSON('@{Defects.loadFilterById()}', param, function(jsonFilter){

                    d = jsonFilter;

                    var form =  document.getElementById('defectsFilterForm');
                    if(!ko.mapping.isMapped(viewModel)){
                        viewModel = ko.mapping.fromJS(d);
                        ko.applyBindings(viewModel, form);
                    }
                    else{
                        ko.mapping.updateFromJS(viewModel,d);
                    }
                    $('#filterLoadDialog').dialog('close');

                }).error(errorHandler);
            }
            
            if($(this).val()==''){
                $('#filter_container').slideUp('slow');
            }

            //clear the form in case a filter was previously applied

            if($(this).val()=='customFilter'){
                $(':input','#defectsFilterForm')
                 .not(':button, :submit, :reset, :hidden')
                 .val('')
                 .removeAttr('checked')
                 .removeAttr('selected');
            }


        });


//        var viewModel={
//            titleCase : ko.observable(d.titleCase.value),
//            title_value : ko.observable(d.title.value),
//            status_value : ko.observable(d.status.value),
//            tags_value : ko.observable(d.tags.value),
//            assignedToId_value : ko.observable(d.assignedToId.value),
//            submittedById_value : ko.observable(d.submittedById.value),
//            dateFrom_value : ko.observable(d.dateFrom.value),
//            dateTo_value : ko.observable(d.dateTo.value)
//        };
//        ko.applyBindings(viewModel);

//        var viewModel={
//            title : ko.observable(d.title.value)
//        }
//        ko.applyBindings(viewModel);
//        var viewModel = ko.mapping.fromJS(d);
//        ko.mapping.updateFromJS(viewModel, d);

</script>