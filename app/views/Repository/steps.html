<div class="shownOnLoad">
  No script selected.
</div>
<div class="hiddenOnLoad">
  #{deadbolt.restrict roles:[[models.general.UnitRole.TESTREPOEDIT]]}
    <button id="createStepButton" class="button-add">Step</button>
    <button id="updateStepButton" class="button-edit">Update step</button>
  #{/deadbolt.restrict}

  <table class="display" id="stepTable">
    <thead>
    <tr>
      <th>Nr</th>
      <th>Name</th>
      <th>Description</th>
      <th>Expected results</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="createStepDialog" title="Create a step">
  #{ox.form id:'createStepForm', action:@Repository.createOrUpdateStep(), baseClass:'models.tm.test.ScriptStep', create:true}
    #{ox.field field:'step.name', label:'Name' /}
    #{ox.field field:'step.position', label:'Position' /}
    #{ox.field field:'step.description', label:'Description' /}
    #{ox.field field:'step.expectedResult', label:'Expected result' /}
    #{ox.field field:'step.id', hidden:true /}
  #{/ox.form}
</div>

<div id="updateStepDialog" title="Update a step">
  #{ox.form id:'updateStepForm', action:@Repository.createOrUpdateStep(), baseClass:'models.tm.test.ScriptStep'}
    #{ox.field field:'step.name', label:'Name' /}
    #{ox.field field:'step.position', label:'Position' /}
    #{ox.field field:'step.description', label:'Description' /}
    #{ox.field field:'step.expectedResult', label:'Expected result' /}
    #{ox.field field:'step.id', hidden:true /}
  #{/ox.form}
</div>


<script type="text/javascript">

  $(document).ready(function() {

    #{tabularasa.init tableId:'stepTable'}
    var stepTableParameters = {
      "aoColumns": [
        {"sName": "id", "sClass": "sNone" },
        {"sName": "position"},
        {"sName": "name"},
        {"sName": "descriptionHTML"},
        {"sName": "expectedResultHTML"}
      ],
      "sAjaxSource": "@{Repository.steps()}",
      "bProcessing": false,
      "bServerSide": true,
      "bFilter": false,
      "bSort": false,
      "bLengthChange": false,
      "iDisplayLength": 10,
      "bScrollCollapse": true,
      "bAutoWidth": false,
      "bInfo": false,
      "oLanguage": {
        "sZeroRecords": "No steps defined yet"
      }
    };
    #{/tabularasa.init}

    function addRequestParameters(parameters, tableId) {
        if(tableId=='stepTable')
            parameters.push({"name": "scriptId", "value": getSelectedNodeId('repositoryTree') });
    }

    handleRowSelection('#stepTable', function() {
      $('#updateStepButton').button('enable');
    });

    $('#createStepButton').click(function() {
      $('#createStepDialog').dialog('open');
    });

    $('#createStepForm').oxForm({
      submissionCallback: function() {
        refreshTableContents('#stepTable', false);
      }
    });

    $('#createStepDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      buttons: {
        "Create step": function() {
          if($('#createStepForm').oxForm('submitCreateForm', {scriptId: getSelectedNodeId('repositoryTree')})) {
            $(this).dialog("close");
          }
        },
        "Cancel": function() {
          $('#createStepForm').validate({meta: 'validate'}).resetForm();
          $(this).dialog("close");
        }
      }
    });

    $('#updateStepButton').click(function() {
      $('#updateStepDialog').dialog('open');
    });

    $('#updateStepForm').oxForm({
      submissionCallback: function() {
        refreshTableContents('#stepTable', false);
      },
      loadAction: '@{Repository.stepDetailsData()}'
    });

    $('#updateStepDialog').dialog({
      autoOpen: false,
      width: 500,
      height: 400,
      draggable: true,
      resizable: false,
      modal: true,
      open: function() {
        $('#updateStepForm').oxForm('load', getSelectedRowId('#stepTable'), {scriptId: getSelectedNodeId('repositoryTree')});
      },
      buttons: {
        "Update step": function() {
          var valid = $('#updateStepForm').validate({meta: 'validate'}).form();
          if(valid) {
            $('#updateStepForm').submit();
            $(this).dialog("close");
          }
        },
        "Cancel": function() {
            //fixing bug with remaining validation message after pressing cancel and reopening dialog
            $('.error').html('');
          $(this).dialog("close");
        }
      }
    });
  });
</script>