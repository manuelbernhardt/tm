<div id='cycleDeleteConfirmationDialog' title="Deletion confirmation of cycle"></div>

<div id="assign_dialog" title="Assign Test Script to Cycle" class="modalDialog">
  <div id="approachTree" class="tree"></div>
</div>


<script type="text/javascript">
  $(document).ready(function() {

    $("#assign_cycle").button({icons: {primary: "ui-icon-plus"}}).click(function() {
      $("#assign_dialog").dialog("open");
    });

    $("#remove_cycle").button({disabled: true, icons: {primary: 'ui-icon-trash'}, text: false}).click(function () {
      deletionConfirmation('cycleDeleteConfirmationDialog','Cycle', getSelectedNodeName('scriptCycleTree'), function(){
          var $tree = jQuery.jstree._reference('#scriptCycleTree');
          var selectedNode = $tree.get_selected();
          if (isSelectedNodeOfType($tree, selectedNode, ['default', 'instance'])) {
            selectedNode.data("args", {scriptId: getSelectedNodeId('repositoryTree')});
            $tree.delete_node(selectedNode);
            refreshCycleTree();
          }
      });

    });

    $("#assign_dialog").dialog({
      autoOpen: false,
      height: 550,
      width: 300,
      modal: true,
      buttons: {
        "Assign": function() {

          var valid = false;
          var treeContainer = $("#approachTree");
          var $tree = jQuery.jstree._reference(treeContainer);
          var selectedNode = $tree.get_selected();
          if ($tree._get_type(selectedNode) == 'testCycle') {
            valid = true;
          } else {
            errorHandler
          }

          if (valid) {
            var name = selectedNode.text();
            $("#scriptCycleTree").jstree("create", -1, "last", {attr: {"rel": "testCycle"}, data: name, metadata: {args: {cycleNodeId: extractId(selectedNode.attr('id')), scriptId: getSelectedNodeId('repositoryTree')}}}, null, true);
            refreshCycleTree();
            $(this).dialog("close");
          }
        },
        Cancel: function() {
          $(this).dialog("close");
        }
      }
    });

    $('#approachTree').tree({"args" : {"projectId": "${project == null ? controllers.TMController.getActiveProject().getId() : project.id}"}, types: approachTreeTypes});

    function refreshCycleTree() {
      var cycleTreeContainer = $("#scriptCycleTree");
      jQuery.jstree._reference(cycleTreeContainer).refresh();
      jQuery.jstree._reference(cycleTreeContainer).deselect_all();
    }

  });
</script>

