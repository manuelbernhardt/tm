#{extends 'main.html' /}
#{set title:'Test preparation' /}


<div class="container">
  <div class="left_tree">
    #{box 'Test Script Repository'}
    <div id="repositoryTree" class="tree" style="border-style:none;"></div>
    #{/box}
  </div>
  <div class="right_tree">

    #{box 'Test Instances'}

    <div class="hiddenOnLoad">
      <div class="left_tree">
        #{include 'Preparation/instanceCreateDialog.html' /}
        <div id="scriptCycleTree" class="tree"></div>
      </div>
      <div class="right_tree">

        <div id="innerTabs">
          <ul>
            <li><a href="#tagsTab"><span>Tags</span></a></li>
            <li><a href="#schedule"><span>Schedule</span></a></li>
            <li><a href="#testData"><span>Test data</span></a></li>
          </ul>
          <div id="tagsTab">
            <div class="instanceShownOnLoad">
              No test instance selected
            </div>
            <div class="instanceHiddenOnLoad" style="display: none;">
              <form id="tagsForm" action="@{Preparation.updateTags()}" method="post">
                <input name="tags" id="tags" type="text"/>
                <button id="tagsSaveButton">Save</button>
              </form>
            </div>
          </div>
          <div id="schedule">
            <div class="instanceShownOnLoad">
              No test instance selected
            </div>
            <div class="instanceHiddenOnLoad" style="display: none;">
              #{ox.form action:@Preparation.updateSchedule(), id:'scheduleForm', baseClass:'models.tm.test.Instance'}
              #{ox.field field:'instance.responsible', label:'Assigned to' /}
              #{ox.field field:'instance.plannedExecution', label:'Planned execution' /}
              #{ox.submit /}
              #{/ox.form}
            </div>
          </div>
          <div id="testData">
            <div class="instanceShownOnLoad">
              No test instance selected
            </div>
            <div class="instanceHiddenOnLoad" style="display: none;">
              <form id="instanceParamForm" method="POST" action="@{Preparation.updateParameters()}" data-bind="submit: submitForm">
                <table id="instanceParamTable" class="display">
                  <thead>
                  <th>Parameter</th>
                  <th>Value</th>
                  </thead>
                  <tbody data-bind="template: {name: 'paramRowTemplate', foreach: params }"></tbody>
                </table>
                <button type="submit" id="saveParamsButton">Save</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="shownOnLoad">
      No test script selected
    </div>


    #{/box}

  </div>
</div>


#{set 'moreScripts'}
<script type="text/html" id="paramRowTemplate">
  <tr>
    <td><span data-bind="text: name"></span></td>
    <td><input id="paramValue" type="text" data-bind="name: id, value: value"></td>
  </tr>
</script>

<script type="text/javascript">

  $(document).ready(function () {

    // selection listener for the repository tree
    $("#repositoryTree").tree({types: repositoryTreeTypes});
    $("#repositoryTree").bind("select_node.jstree", function (e, data) {
      if (isSelectedNodeType(data, ["script", "default"])) {

        $('.instanceHiddenOnLoad').hide();
        $('.instanceShownOnLoad').show();
        
        jQuery.jstree._reference("#scriptCycleTree").load_node_json(-1, false, false);
        $('.hiddenOnLoad').show();
        $('.shownOnLoad').hide();
      }
    });

    // viewModel for instance parameters
    var paramViewModel = {'submitForm': function(formElement) {
      $.ajax({
        url: $(formElement).attr('action'),
        type: 'POST',
        data: $.extend({instanceId: getSelectedNodeId('scriptCycleTree')}, {params: ko.mapping.toJSON(paramViewModel)}),
        success: function() {
          $('#saveParamsButton').button('disable');
        },
        error: function() {
          alert("Something went wrong, please try again");
        }
      });
      return false;
    }};

    // selection listener for the instance tree
    $("#scriptCycleTree").tree({"args" : getScriptQuery, types: scriptCycleTreeTypes});
    $("#scriptCycleTree").bind("select_node.jstree", function (e, data) {
      if (isSelectedNodeType(data, ["instance", "default"])) {
        $('.instanceHiddenOnLoad').show();
        $('.instanceShownOnLoad').hide();

        var instanceId = getNodeIdFromData(data);

        // tags data loading
        $.getJSON('@{Preparation.tags()}', {instanceId: instanceId}, function(data) {
          tokens.clearTokens();
          $(data).each(function() {
            tokens.addToken(this.id, this.name);
          });
        });

        // schedule data loading
        $('#scheduleForm').oxForm('load', instanceId);

        // instance parameter data loading
        $.getJSON('@{Preparation.instanceParameters()}', {instanceId: instanceId}, function(data) {
          if (!ko.mapping.isMapped(paramViewModel)) {
            $.extend(paramViewModel, ko.mapping.fromJS(data));
            ko.applyBindings(paramViewModel, document.getElementById('instanceParamForm'));
          } else {
            ko.mapping.updateFromJS(paramViewModel, data);
          }
          // apply focus listeners for the save button
          $('#instanceParamForm').find('input').each(function(index, value) {
            $(value).focus(function() {
              $('#saveParamsButton').button('enable');
            });
          });
        });
      }
    });

    $('#innerTabs').tabs();

    function getScriptQuery() {
      return {'scriptId': getSelectedNodeId('repositoryTree') ? getSelectedNodeId('repositoryTree') : -1}
    }

    function getInstanceQuery() {
      return {'instanceId': getSelectedNodeId('scriptCycleTree')};
    }

    // tags
    var tokens = $('#tags').tokenInput('@{Preparation.allTags()}', {
      preventDuplicates: true,
      tokenValue: 'name',
      allowCreation: true,
      creationText: "Create new tag"
    });

    $('#tagsSaveButton').button();
    $('#tagsForm li.token-input-input-token').focus(function() {
      $('#tagsSaveButton').button('enable');
    });
    $('#tagsForm').ajaxForm({
      success: function() {
        $('#tagsSaveButton').button('disable');
      },
      beforeSubmit: function(arr, $form, options) {
        arr.push({name:'instanceId', value: getSelectedNodeId('scriptCycleTree')});
        return true;
      }
    });

    $('#scheduleForm').oxForm({
      loadAction: '@{Preparation.schedule()}',
      submissionParameters: getInstanceQuery
    });

    $('#saveParamsButton').button();
  });

</script>
#{/set}
