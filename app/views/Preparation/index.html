#{extends 'main.html' /}
#{set title:'Test preparation' /}


<div class="container">
  <div class="left_tree">
    #{box 'Test Script Repository'}
    <div id="repositoryTree" class="tree" style="border-style:none;"></div>
    #{/box}
  </div>
  <div class="right_tree">

    #{box 'Test Script'}
    <div class="left_tree">
      #{include 'Preparation/instanceCreateDialog.html' /}
      <div id="scriptCycleTree" class="tree"></div>
    </div>
    <div class="right_tree">

      <div id="innerTabs">
        <ul>
          <li><a href="#tagsTab"><span>Tags</span></a></li>
          <li><a href="#schedule"><span>Schedule</span></a></li>
          <li><a href="#testData"><span>Test data</span></a></li>
        </ul>
        <div id="tagsTab">
          <form id="tagsForm" action="@{Preparation.addTags()}" method="post">
            <input name="tags" id="tags" type="text"/>
            <button id="tagsSaveButton">Save</button>
          </form>
        </div>
        <div id="schedule">
          #{ox.form action:@Preparation.editSchedule(), id:'scheduleForm', baseClass:'models.tm.test.Instance'}
          #{ox.field field:'instance.responsible', label:'Assigned to' /}
          #{ox.field field:'instance.plannedExecution', label:'Planned execution' /}
          #{input.submit /}
          #{/ox.form}
        </div>
        <div id="testData">
          <form id="instanceParamForm" method="POST" action="@{Preparation.editData()}" data-bind="submit: submitForm">
            <table id="instanceParamTable" class="display">
              <thead>
              <th>Parameter</th>
              <th>Value</th>
              </thead>
              <tbody data-bind="template: {name: 'paramRowTemplate', foreach: params }"></tbody>
            </table>
            <button type="submit" id="saveParamsButton">Save</button>
          </form>

        </div>
      </div>

    </div>
    #{/box}

  </div>
</div>


#{set 'moreScripts'}
<script type="text/html" id="paramRowTemplate">
  <tr>
    <td><span data-bind="text: name"></span></td>
    <td><input id="paramValue" type="text" data-bind="name: id, value: value"></td>
  </tr>
</script>

<script type="text/javascript">

  $(document).ready(function () {

    $("#repositoryTree").tree({types: repositoryTreeTypes});
    $("#repositoryTree").bind("select_node.jstree", function (e, data) {
      if (isSelectedNodeType(data, ["script", "default"])) {
        jQuery.jstree._reference("#scriptCycleTree").load_node_json(-1, false, false);
      }
    });

    var paramViewModel = {'submitForm': function(formElement) {
      $.ajax({
        url: $(formElement).attr('action'),
        type: 'POST',
        data: $.extend({instanceId: getSelectedNodeId('scriptCycleTree')}, {params: ko.mapping.toJSON(paramViewModel)}),
        success: function() {
          $('#saveParamsButton').button('disable');
        },
        error: function() {
          alert("Something went wrong, please try again");
        }
      });
      return false;
    }};

    $("#scriptCycleTree").tree({"args" : getScriptQuery, types: scriptCycleTreeTypes});
    $("#scriptCycleTree").bind("select_node.jstree", function (e, data) {
      if (isSelectedNodeType(data, ["instance", "default"])) {
        var instanceId = getNodeIdFromData(data);

        // tags
        $.getJSON('@{Preparation.tags()}', {instanceId: instanceId}, function(data) {
          tokens.clearTokens();
          $(data).each(function() {
            tokens.addToken(this.id, this.name);
          });
        });

        // schedule
        $('#scheduleForm').oxForm('load', instanceId);

        // instance parameters
        $.getJSON('@{Preparation.instanceParameters()}', {instanceId: instanceId}, function(data) {
          if (!ko.mapping.isMapped(paramViewModel)) {
            $.extend(paramViewModel, ko.mapping.fromJS(data));
            ko.applyBindings(paramViewModel, document.getElementById('instanceParamForm'));
          } else {
            ko.mapping.updateFromJS(paramViewModel, data);
          }
          // apply focus listeners for the save button
          $('#instanceParamForm').find('input').each(function(index, value) {
            $(value).focus(function() {
              $('#saveParamsButton').button('enable');
            });
          });
        });
      }
    });

    function getScriptQuery() {
      return {'scriptId': getSelectedNodeId('repositoryTree') ? getSelectedNodeId('repositoryTree') : -1}
    }

    function getInstanceQuery() {
      return {'instanceId': getSelectedNodeId('scriptCycleTree')};
    }

    $('#innerTabs').tabs();

    var tokens = $('#tags').tokenInput(getTagSearchURL, {
      preventDuplicates: true,
      tokenValue: 'name',
      allowCreation: true,
      creationText: "Create new tag"
    });

    function getTagSearchURL() {
      return '@{Preparation.allTags()}?instanceId=' + getSelectedNodeId('scriptCycleTree');
    }

    $('#tagsSaveButton').button();
    $('#tagsForm li.token-input-input-token').focus(function() {
      $('#tagsSaveButton').button('enable');
    });
    $('#tagsForm').ajaxForm({
      success: function() {
        $('#tagsSaveButton').button('disable');
      },
      beforeSubmit: function(arr, $form, options) {
        arr.push({name:'instanceId', value: getSelectedNodeId('scriptCycleTree')});
        return true;
      }
    });

    $('#scheduleForm').oxForm({
      loadAction: '@{Preparation.scheduleData()}',
      submissionParameters: getInstanceQuery
    });

    $('#saveParamsButton').button();
  });

</script>
#{/set}
